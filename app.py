# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1mU7YAFWsT4mH6wN9sIoezbkHBzWFfmqA
"""

import os

# Flask æ˜¯ Python Web Frameworkï¼Œé€™è£¡ç”¨ä¾†å»ºç«‹ä¸€å€‹ Web æ‡‰ç”¨
from flask import Flask, request, abort

# åŒ¯å…¥ LINE Bot SDK çš„ Webhook è™•ç†å™¨
from linebot.v3.webhook import WebhookHandler

# åŒ¯å…¥ LINE SDK ä¸­çš„ Signature éŒ¯èª¤é¡åˆ¥ï¼ˆç”¨ä¾†è™•ç†ç„¡æ•ˆç°½ç« çš„ä¾‹å¤–æƒ…æ³ï¼‰
from linebot.v3.exceptions import InvalidSignatureError

# åŒ¯å…¥ LINE Messaging API ä¸­çš„å·¥å…·èˆ‡è³‡æ–™æ¨¡å‹
from linebot.v3.messaging import (
    ApiClient,                # LINE Bot API çš„å®¢æˆ¶ç«¯
    Configuration,            # å„²å­˜å­˜å–æ†‘è­‰çš„è¨­å®šç‰©ä»¶
    MessagingApi,             # æä¾›è¨Šæ¯ç™¼é€ç­‰åŠŸèƒ½
    ReplyMessageRequest,      # å›è¦†è¨Šæ¯çš„è«‹æ±‚æ ¼å¼
    TextMessage               # ç”¨ä¾†å›å‚³æ–‡å­—è¨Šæ¯
)

# åŒ¯å…¥ webhook çš„äº‹ä»¶èˆ‡å…§å®¹é¡å‹
from linebot.v3.webhooks import (
    MessageEvent,             # è¨Šæ¯äº‹ä»¶
    TextMessageContent        # ç´”æ–‡å­—è¨Šæ¯å…§å®¹
)

# å»ºç«‹ Flask æ‡‰ç”¨ç¨‹å¼ç‰©ä»¶
app = Flask(__name__)

# å»ºç«‹ LINE Bot è¨­å®šï¼šä½¿ç”¨å„²å­˜åœ¨ userdata è£¡çš„ Channel Access Token
configuration = Configuration(access_token=os.getenv('LINE_CHANNEL_ACCESS_TOKEN'))

# å»ºç«‹ webhook handlerï¼šç”¨ä¾†é©—è­‰å’Œè™•ç†ä¾†è‡ª LINE çš„è«‹æ±‚
line_handler = WebhookHandler(os.getenv('LINE_CHANNEL_SECRET'))

# ğŸ” ç•¶ LINE çš„ webhook POST è¨Šæ¯å‚³ä¾†æ™‚æœƒé€²å…¥é€™å€‹ callback è·¯ç”±
@app.route("/callback", methods=['POST'])
def callback():
    # å¾ HTTP æ¨™é ­ä¸­å–å¾—ç°½åè³‡è¨Š
    signature = request.headers['X-Line-Signature']

    # å–å¾—è«‹æ±‚çš„ä¸»é«”ï¼ˆä¹Ÿå°±æ˜¯ LINE å‚³ä¾†çš„è¨Šæ¯è³‡æ–™ï¼‰
    body = request.get_data(as_text=True)
    app.logger.info("Request body: " + body)  # å°‡æ”¶åˆ°çš„è¨Šæ¯å…§å®¹è¼¸å‡ºåˆ°ä¼ºæœå™¨ log

    # é©—è­‰ç°½åä¸¦è™•ç† webhook
    try:
        line_handler.handle(body, signature)  # ä½¿ç”¨ webhook handler é©—è­‰ä¸¦è™•ç†è¨Šæ¯
    except InvalidSignatureError:
        # å¦‚æœç°½åé©—è­‰å¤±æ•—ï¼Œå›å‚³éŒ¯èª¤ä¸¦ä¸­æ­¢è™•ç†
        app.logger.info("Invalid signature. Please check your channel access token/channel secret.")
        abort(400)

    return 'OK'  # é©—è­‰æˆåŠŸå¾Œï¼Œå›å‚³ OK çµ¦ LINE Serverï¼ˆä»£è¡¨ webhook è™•ç†å®Œç•¢ï¼‰


import google.generativeai as genai

genai.configure(api_key=os.getenv("Google_api_key"))
model = genai.GenerativeModel("gemini-2.0-flash")
def ask_gemini(question):
  response = model.generate_content(question)
  return response.text


# ç•¶æ”¶åˆ°æ–‡å­—è¨Šæ¯æ™‚æœƒè§¸ç™¼é€™å€‹äº‹ä»¶è™•ç†å‡½å¼
@line_handler.add(MessageEvent, message=TextMessageContent)
def handle_message(event):
    # ä½¿ç”¨ access_token å»ºç«‹ Messaging API å®¢æˆ¶ç«¯
    with ApiClient(configuration) as api_client:
        line_bot_api = MessagingApi(api_client)
        response = ask_gemini(event.message.text)

        # å›è¦†èˆ‡ä½¿ç”¨è€…è¼¸å…¥ç›¸åŒçš„è¨Šæ¯ï¼ˆå›è²æ©Ÿå™¨äºº Echo Botï¼‰
        line_bot_api.reply_message_with_http_info(
            ReplyMessageRequest(
                reply_token=event.reply_token,  # ç”¨ä¾†è­˜åˆ¥æ˜¯å“ªå€‹è¨Šæ¯éœ€è¦è¢«å›è¦†
                messages=[
                  TextMessage(text=response)
                ]  # å›è¦†çš„è¨Šæ¯å…§å®¹
            )
        )

# å¦‚æœé€™æ”¯ç¨‹å¼æ˜¯å¾ä¸»ç¨‹å¼å•Ÿå‹•ï¼Œå°±å•Ÿå‹• Flask ä¼ºæœå™¨
if __name__ == "__main__":
  app.run()